<?php
/**
 * @file
 * Code for the GIE General feature.
 */

include_once 'gie_general.features.inc';

/**
 * Implements hook_menu_alter().
 * - Alter title of 'User Account' link.
 */
function gie_general_menu_alter(&$items) {
  $items['user']['title callback'] = '_gie_general_welcome';
}

/**
 * Callback to generate dynamic Welcome text.
 */
function _gie_general_welcome() {
  if (user_is_logged_in()) {
    $user = entity_metadata_wrapper('user', $GLOBALS['user']);
    $first_name = $user->field_user_firstname->value();

    // Temporary if statement to place filled in name
    // TODO: remove this statement if first name becomes required
    if (!empty($first_name)) {
      $name = $first_name;
    } else {
      $name = $user->name->value();
    }
    return t('Welcome, ') . $name . '!';
  } else {
    return t('User account');
  }
}

/**
 * Implements hook_comment_insert().
 * - Trigger Comment Notify message
 */
function gie_general_comment_insert($comment) {
  $node = node_load($comment->nid);
  if ($comment->uid == $node->uid) {
    // Same comment author as node author
    return;
  }

  $message = message_create('comment_notify', array('uid' => $node->uid));
  $wrapper = entity_metadata_wrapper('message', $message);
  $wrapper->field_node_ref->set($node);
  $wrapper->field_comment_ref->set($comment);

  message_notify_send_message($message);

}
